<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cpp2np: cpp2np</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cpp2np
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">cpp2np </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Requirements</h1>
<pre class="fragment">Python &gt;= 3.9
numpy &gt;= 1.23.4
g++ &gt;= 9.3.0
GNU Make &gt;= 4.2.1
</pre><p>Zusätzliche requirements für <code>demo2.py</code>: </p><pre class="fragment">pillow &gt;= 9.4.0
matplotlib &gt;= 3.6.2
scipy &gt;= 1.9.2
</pre><p>Generieren der doxygen Dokumentation (optional):</p>
<ol type="1">
<li>Installation von doxygen</li>
<li>Befehl: <pre class="fragment"> doxygen docs/config
</pre></li>
</ol>
<h1><a class="anchor" id="autotoc_md2"></a>
Installation</h1>
<p>Zur Installation führt man den 'make' Befehl im Root-Verzeichnis des Projektes aus. </p><pre class="fragment">make
</pre><p>Das cpp2np Modul wird automatisch gebaut und im environment installiert. Im Makefile gibt es noch den unten stehenden Abschnitt. Damit steuert man, ob die .so Datei lokal im Projekt installiert wird, oder global. </p><pre class="fragment"># use for debugging (local)
    pip install -e .
# use for production (global)
#   pip install .
</pre><h1><a class="anchor" id="autotoc_md3"></a>
Problem mit setup.py</h1>
<p>Falls die Installation nicht klappt, könnte eine Lösung sein, die .so Datei manuell zum Pfad der dynamic linked libraries hinzuzufügen.</p>
<p>Dazu führt man folgenden Befehl im Root-Verzeichnis des Projektes aus: </p><pre class="fragment">echo export LD_LIBRARY_PATH=$(pwd)/build/lib.linux-x86_64-cpython-310 &gt;&gt; ~/.bashrc
</pre><h1><a class="anchor" id="autotoc_md4"></a>
Demo 1: Python(C++)</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Import module</h2>
<div class="fragment"><div class="line">import cpp2np as c2n</div>
<div class="line">import numpy as np</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md6"></a>
Get pointer to 2x2 std::array allocated by c++:</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; pointer, shape = c2n.c_arr_i4()</div>
<div class="line">&gt;&gt;&gt; print(pointer)</div>
<div class="line">&gt;&gt;&gt; print(shape)</div>
<div class="line"> </div>
<div class="line">24245840</div>
<div class="line">(2, 2)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Wrap pointer in numpy array</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; wrapper = c2n.wrap(pointer, shape, dtype=np.dtype(&quot;int32&quot;))</div>
<div class="line">&gt;&gt;&gt; print(wrapper)</div>
<div class="line">&gt;&gt;&gt; print(type(wrapper))</div>
<div class="line"> </div>
<div class="line">[[1 2]</div>
<div class="line">[3 4]]</div>
<div class="line"> </div>
<div class="line">&lt;class numpy.ndarray&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Change value in numpy array</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; wrapper[0,0] = 255</div>
<div class="line">&gt;&gt;&gt; print(wrapper)</div>
<div class="line"> </div>
<div class="line">[[255   2]</div>
<div class="line">[  3   4]]</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
Delete numpy array and create new wrapper from same pointer</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; del wrapper</div>
<div class="line">&gt;&gt;&gt; wrapper2 = c2n.wrap(pointer, shape, dtype=np.dtype(&quot;int32&quot;))</div>
<div class="line">&gt;&gt;&gt; print(wrapper2)</div>
<div class="line"> </div>
<div class="line">[[255   2]</div>
<div class="line">[  3   4]]</div>
</div><!-- fragment --><p>(We observe the change of value in first wrapper was done on the original memory buffer, as it also shows up in the new wrapper. Also deleting the wrapper did not delete the buffer.)</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Get information of underlying data of the wrapper</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; print(c2n.descr(wrapper2))</div>
<div class="line"> </div>
<div class="line">{&#39;data&#39;: 24245840, &#39;ndim&#39;: 2, &#39;shape&#39;: (2, 2), &#39;typestr&#39;: &#39;&lt;i4&#39;}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
To check if data is contiguous we can look into flags attribute of the numpy array</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; print(&quot;C contiguous: &quot; + str(wrapper2.flags[&#39;C_CONTIGUOUS&#39;]))</div>
<div class="line">&gt;&gt;&gt; print(&quot;F contiguous: &quot; + str(wrapper2.flags[&#39;F_CONTIGUOUS&#39;]))</div>
<div class="line"> </div>
<div class="line">C contiguous: True</div>
<div class="line">F contiguous: False</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
Flags overview</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; wrapper2.flags</div>
<div class="line"> </div>
<div class="line">C_CONTIGUOUS : True</div>
<div class="line">F_CONTIGUOUS : False</div>
<div class="line">OWNDATA : False</div>
<div class="line">WRITEABLE : True</div>
<div class="line">ALIGNED : True</div>
<div class="line">WRITEBACKIFCOPY : False</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
Free the memory of the c++ array explicitly</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; c2n.free(pointer)</div>
<div class="line">&gt;&gt;&gt; print(wrapper2)</div>
<div class="line"> </div>
<div class="line">[[24407120        0]</div>
<div class="line">[19943440        0]]</div>
</div><!-- fragment --><p>We observe that the numpy array is pointing nowhere as the original buffer was freed on the c++ side.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Demo 2</h1>
<p>Apart from the source module in <code>demo2.py</code> there's a html file and jupyter notebook in the docs directory containing sample outputs of the script: <em>docs/demo2.html</em>.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Demo 3: C++(Python)</h1>
<p>Demonstrates the usage of cpp2np in the other direction. Allocating memory in numpy, then access and use it in C++.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Create regular numpy array:</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; new_arr = np.ones((8,8), dtype=&quot;uint8&quot;)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md17"></a>
Retrieve pointer</h2>
<div class="fragment"><div class="line">&gt;&gt;&gt; ptr = c2n.descr(new_arr)[&#39;data&#39;]</div>
<div class="line">&gt;&gt;&gt; print(&quot;pointer in python: &quot; + str(ptr))</div>
<div class="line"> </div>
<div class="line">pointer in python: 35841504</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
Disable OWNDATA flag</h2>
<p>By disabling this flag we prevent the numpy array from the deleting the memory while we are still using it in C++.</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; c2n.owndata(new_arr, False)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md19"></a>
Test if disabling the flag worked</h2>
<p>Now we delete the numpy array and check if the memory area is still there. Before we print, we do some allocations of new memory blocks which would likely cause the original data area to get overriden if it had been freed.</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; del new_arr</div>
<div class="line"># do some stuff in memory </div>
<div class="line">&gt;&gt;&gt; a = np.zeros((10,10), dtype=&quot;double&quot;)</div>
<div class="line">&gt;&gt;&gt; b = np.zeros((5,5))</div>
<div class="line"># now print memory the pointer is referencing</div>
<div class="line">&gt;&gt;&gt; print(&quot;\nprint numpy data from c++:&quot;)</div>
<div class="line">&gt;&gt;&gt; c2n.print_testarr(ptr)</div>
<div class="line"> </div>
<div class="line">print numpy data from c++:</div>
<div class="line">pointer address: 35841504</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
</div><!-- fragment --><p>Thankfully we can see that the memory still exists, even after deletion of the numpy array.</p>
<h2><a class="anchor" id="autotoc_md20"></a>
Free numpy allocated data from C++:</h2>
<p>When the c++ object is done using the memory, it can use <code>cpp2np_py_free</code> to free the data. Note that this is a different method than <code>cpp2np_free</code>, as Python has its own memory management.</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; c2n.py_free(ptr)</div>
</div><!-- fragment --><p>Now we can check again to see if we can still access the memory from c++:</p>
<div class="fragment"><div class="line"># some memory stuff happening again</div>
<div class="line">&gt;&gt;&gt; a = np.zeros((10,10), dtype=&quot;double&quot;)</div>
<div class="line">&gt;&gt;&gt; b = np.zeros((5,5))</div>
<div class="line"># try to print data</div>
<div class="line">&gt;&gt;&gt; c2n.print_testarr(ptr)</div>
<div class="line"> </div>
<div class="line">pointer address: 35841504</div>
<div class="line">[   0    0    0    0    0    0    0    0]</div>
<div class="line">[  16   96  226    1    0    0    0    0]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
<div class="line">[   1    1    1    1    1    1    1    1]</div>
</div><!-- fragment --><p>We see the data area was overwritten by other objects in memory, which means it got freed by our method. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
